name: Daily Data Update

# Run every day at 11:30 AM EST (4:30 PM UTC)
on:
  schedule:
    - cron: '30 16 * * *'
  # Also allow manual trigger
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install kenpompy requests databricks-sql-connector pandas pyarrow python-dotenv

      - name: Run data pull script
        env:
          KENPOM_EMAIL: ${{ secrets.KENPOM_EMAIL }}
          KENPOM_PASSWORD: ${{ secrets.KENPOM_PASSWORD }}
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_HTTP_PATH: ${{ secrets.DATABRICKS_HTTP_PATH }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          python APIPull.py

      - name: Set up dbt
        run: |
          pip install dbt-databricks

      - name: Create dbt profiles.yml
        run: |
          mkdir -p ~/.dbt
          cat > ~/.dbt/profiles.yml << EOF
          cbb_analytics:
            outputs:
              dev:
                catalog: workspace
                host: ${{ secrets.DATABRICKS_HOST }}
                http_path: ${{ secrets.DATABRICKS_HTTP_PATH }}
                schema: default
                threads: 1
                token: ${{ secrets.DATABRICKS_TOKEN }}
                type: databricks
            target: dev
          EOF

      - name: Run dbt
        run: |
          cd cbb_analytics
          dbt deps
          dbt run

      - name: Generate game predictions
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_HTTP_PATH: ${{ secrets.DATABRICKS_HTTP_PATH }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
          ODDS_API_KEY: ${{ secrets.ODDS_API_KEY }}
        run: |
          python GamePredictions.py

      - name: Update game results
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_HTTP_PATH: ${{ secrets.DATABRICKS_HTTP_PATH }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          python UpdateResults.py

      - name: Summary
        run: |
          echo "âœ… Data pipeline completed successfully!"
          echo "ðŸ“Š KenPom data refreshed"
          echo "ðŸ”„ dbt transformations applied"
          echo "ðŸŽ¯ Game predictions generated"
          echo "ðŸ“ˆ Game results updated"
          echo "ðŸŒ Dashboard will show updated data"
